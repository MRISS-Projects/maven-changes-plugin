<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GitHubDownloader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Maven Changes Plugin</a> &gt; <a href="index.source.html" class="el_package">org.apache.maven.plugins.github</a> &gt; <span class="el_source">GitHubDownloader.java</span></div><h1>GitHubDownloader.java</h1><pre class="source lang-java linenums">package org.apache.maven.plugins.github;

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.apache.maven.plugin.logging.Log;
import org.apache.maven.plugins.issues.Issue;
import org.apache.maven.project.MavenProject;
import org.apache.maven.settings.Proxy;
import org.apache.maven.settings.Server;
import org.apache.maven.settings.Settings;
import org.apache.maven.settings.building.SettingsProblem;
import org.apache.maven.settings.crypto.DefaultSettingsDecryptionRequest;
import org.apache.maven.settings.crypto.SettingsDecrypter;
import org.apache.maven.settings.crypto.SettingsDecryptionResult;
import org.eclipse.egit.github.core.Label;
import org.eclipse.egit.github.core.client.GitHubClient;
import org.eclipse.egit.github.core.service.IssueService;


/**
 * @since 2.8
 */
public class GitHubDownloader
{

    /**
     * The github client.
     */
    private GitHubClient client;

    /**
     * A boolean to indicate if we should include open issues as well
     */
    private boolean includeOpenIssues;

    /**
     * A boolean to indicate if we should only include issues with milestones
     */
    private boolean onlyMilestoneIssues;

    /**
     * The owner/organization of the github repo.
     */
    private String githubOwner;

    /**
     * The name of the github repo.
     */
    private String githubRepo;

    /**
     * The url to the github repo's issue management
     */
    private String githubIssueURL;

    public GitHubDownloader( MavenProject project, String githubScheme, int githubPort, boolean includeOpenIssues,
            boolean onlyMilestoneIssues ) throws MalformedURLException
<span class="fc" id="L84">    {</span>
<span class="fc" id="L85">        this.includeOpenIssues = includeOpenIssues;</span>
<span class="fc" id="L86">        this.onlyMilestoneIssues = onlyMilestoneIssues;</span>

<span class="fc" id="L88">        URL githubURL = new URL( project.getIssueManagement().getUrl() );</span>

        // The githubclient prefers to connect to 'github.com' using the api domain, unlike github enterprise
        // which can connect fine using its domain, so for github.com use empty constructor
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">        if ( githubURL.getHost().equalsIgnoreCase( &quot;github.com&quot; ) )</span>
        {
<span class="fc" id="L94">            this.client = new GitHubClient();</span>
        }
        else
        {
<span class="nc" id="L98">            this.client = new GitHubClient( githubURL.getHost(), githubPort, githubScheme );</span>
        }

<span class="fc" id="L101">        this.githubIssueURL = project.getIssueManagement().getUrl();</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">        if ( !this.githubIssueURL.endsWith( &quot;/&quot; ) )</span>
        {
<span class="fc" id="L104">            this.githubIssueURL = this.githubIssueURL + &quot;/&quot;;</span>
        }

<span class="fc" id="L107">        String urlPath = githubURL.getPath();</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if ( urlPath.startsWith( &quot;/&quot; ) )</span>
        {
<span class="fc" id="L110">            urlPath = urlPath.substring( 1 );</span>
        }

<span class="fc bfc" id="L113" title="All 2 branches covered.">        if ( urlPath.endsWith( &quot;/&quot; ) )</span>
        {
<span class="fc" id="L115">            urlPath = urlPath.substring( 0, urlPath.length() - 2 );</span>
        }

<span class="fc" id="L118">        String[] urlPathParts = urlPath.split( &quot;/&quot; );</span>

<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if ( urlPathParts.length != 3 )</span>
        {
<span class="nc" id="L122">            throw new MalformedURLException(</span>
                    &quot;GitHub issue management URL must look like, &quot; + &quot;[GITHUB_DOMAIN]/[OWNER]/[REPO]/issues&quot; );
        }

<span class="fc" id="L126">        this.githubOwner = urlPathParts[0];</span>
<span class="fc" id="L127">        this.githubRepo = urlPathParts[1];</span>
<span class="fc" id="L128">    }</span>

    public void configureProxy( Settings settings )
    {
<span class="fc" id="L132">        List&lt;Proxy&gt; proxies = settings.getProxies();</span>
<span class="pc bpc" id="L133" title="2 of 4 branches missed.">        if ( proxies != null &amp;&amp; !proxies.isEmpty() )</span>
        {
<span class="nc bnc" id="L135" title="All 2 branches missed.">            for ( Iterator&lt;Proxy&gt; iterator = proxies.iterator(); iterator.hasNext(); )</span>
            {
<span class="nc" id="L137">                Proxy proxy = (Proxy) iterator.next();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                if ( System.getProperty( &quot;http.proxyHost&quot; ) == null</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                        || System.getProperty( &quot;http.proxyHost&quot; ).isEmpty() )</span>
                {
<span class="nc" id="L141">                    System.setProperty( &quot;http.proxyHost&quot;, proxy.getHost() );</span>
<span class="nc" id="L142">                    System.setProperty( &quot;http.proxyPort&quot;, Integer.toString( proxy.getPort() ) );</span>
                }
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if ( System.getProperty( &quot;https.proxyHost&quot; ) == null</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                        || System.getProperty( &quot;https.proxyHost&quot; ).isEmpty() )</span>
                {
<span class="nc" id="L147">                    System.setProperty( &quot;https.proxyHost&quot;, proxy.getHost() );</span>
<span class="nc" id="L148">                    System.setProperty( &quot;https.proxyPort&quot;, Integer.toString( proxy.getPort() ) );</span>
                }
                break;
            }
        }
<span class="fc" id="L153">    }</span>

    protected Issue createIssue( org.eclipse.egit.github.core.Issue githubIssue )
    {
<span class="fc" id="L157">        Issue issue = new Issue();</span>

<span class="fc" id="L159">        issue.setKey( String.valueOf( githubIssue.getNumber() ) );</span>
<span class="fc" id="L160">        issue.setId( String.valueOf( githubIssue.getNumber() ) );</span>

<span class="fc" id="L162">        issue.setLink( this.githubIssueURL + githubIssue.getNumber() );</span>

<span class="fc" id="L164">        issue.setCreated( githubIssue.getCreatedAt() );</span>

<span class="fc" id="L166">        issue.setUpdated( githubIssue.getUpdatedAt() );</span>

<span class="fc bfc" id="L168" title="All 2 branches covered.">        if ( githubIssue.getAssignee() != null )</span>
        {
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">            if ( githubIssue.getAssignee().getName() != null )</span>
            {
<span class="nc" id="L172">                issue.setAssignee( githubIssue.getAssignee().getName() );</span>
            }
            else
            {
<span class="fc" id="L176">                issue.setAssignee( githubIssue.getAssignee().getLogin() );</span>
            }
        }

<span class="fc" id="L180">        issue.setTitle( githubIssue.getTitle() );</span>

<span class="fc" id="L182">        issue.setSummary( githubIssue.getTitle() );</span>

<span class="fc bfc" id="L184" title="All 2 branches covered.">        if ( githubIssue.getMilestone() != null )</span>
        {
<span class="fc" id="L186">            issue.addFixVersion( githubIssue.getMilestone().getTitle() );</span>
        }

<span class="fc" id="L189">        issue.setReporter( githubIssue.getUser().getLogin() );</span>

<span class="fc bfc" id="L191" title="All 2 branches covered.">        if ( githubIssue.getClosedAt() != null )</span>
        {
<span class="fc" id="L193">            issue.setStatus( &quot;closed&quot; );</span>
        }
        else
        {
<span class="fc" id="L197">            issue.setStatus( &quot;open&quot; );</span>
        }

<span class="fc" id="L200">        List&lt;Label&gt; labels = githubIssue.getLabels();</span>
<span class="fc bfc" id="L201" title="All 4 branches covered.">        if ( labels != null &amp;&amp; !labels.isEmpty() )</span>
        {
<span class="fc" id="L203">            issue.setType( labels.get( 0 ).getName() );</span>
        }

<span class="fc" id="L206">        return issue;</span>
    }

    public List&lt;Issue&gt; getIssueList() throws IOException
    {
<span class="fc" id="L211">        List&lt;Issue&gt; issueList = new ArrayList&lt;Issue&gt;();</span>

<span class="fc" id="L213">        IssueService service = new IssueService( client );</span>
<span class="fc" id="L214">        Map&lt;String, String&gt; issueFilter = new HashMap&lt;String, String&gt;();</span>

<span class="fc bfc" id="L216" title="All 2 branches covered.">        if ( includeOpenIssues )</span>
        {
            // Adding open issues

<span class="fc bfc" id="L220" title="All 2 branches covered.">            for ( org.eclipse.egit.github.core.Issue issue : service.getIssues( githubOwner, githubRepo, issueFilter ) )</span>
            {
<span class="pc bpc" id="L222" title="3 of 4 branches missed.">                if ( !onlyMilestoneIssues || issue.getMilestone() != null )</span>
                {
<span class="fc" id="L224">                    issueList.add( createIssue( issue ) );</span>
                }
<span class="fc" id="L226">            }</span>
        }

        // Adding closed issues

<span class="fc" id="L231">        issueFilter.put( &quot;state&quot;, &quot;closed&quot; );</span>

<span class="fc bfc" id="L233" title="All 2 branches covered.">        for ( org.eclipse.egit.github.core.Issue issue : service.getIssues( githubOwner, githubRepo, issueFilter ) )</span>
        {
<span class="fc bfc" id="L235" title="All 4 branches covered.">            if ( !onlyMilestoneIssues || issue.getMilestone() != null )</span>
            {
<span class="fc" id="L237">                issueList.add( createIssue( issue ) );</span>
            }
<span class="fc" id="L239">        }</span>

<span class="fc" id="L241">        return issueList;</span>
    }

    public void configureAuthentication( SettingsDecrypter decrypter, String githubAPIServerId, Settings settings,
            Log log )
    {

<span class="fc" id="L248">        boolean configured = false;</span>

<span class="fc" id="L250">        List&lt;Server&gt; servers = settings.getServers();</span>

<span class="fc bfc" id="L252" title="All 2 branches covered.">        for ( Server server : servers )</span>
        {
<span class="fc bfc" id="L254" title="All 2 branches covered.">            if ( server.getId().equals( githubAPIServerId ) )</span>
            {
<span class="fc" id="L256">                SettingsDecryptionResult result = decrypter.decrypt( new DefaultSettingsDecryptionRequest( server ) );</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">                for ( SettingsProblem problem : result.getProblems() )</span>
                {
<span class="fc" id="L259">                    log.error( problem.getMessage(), problem.getException() );</span>
<span class="fc" id="L260">                }</span>
<span class="fc" id="L261">                server = result.getServer();</span>
<span class="fc" id="L262">                String user = server.getUsername();</span>
<span class="fc" id="L263">                String password = server.getPassword();</span>
<span class="fc" id="L264">                this.client.setCredentials( user, password );</span>

<span class="fc" id="L266">                configured = true;</span>
<span class="fc" id="L267">                break;</span>
            }
<span class="fc" id="L269">        }</span>

<span class="fc bfc" id="L271" title="All 2 branches covered.">        if ( !configured )</span>
        {
<span class="fc" id="L273">            log.warn( &quot;Can't find server id [&quot; + githubAPIServerId + &quot;] configured in githubAPIServerId.&quot; );</span>
        }
<span class="fc" id="L275">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>